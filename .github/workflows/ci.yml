name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Analyze
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Melos
        uses: bluefireteam/melos-action@v3
        with:
          melos-version: '7.3.0'

      - name: Check formatting
        run: melos exec -- dart format --set-exit-if-changed .

      - name: Generate code
        run: melos run build_runner

      - name: Analyze
        run: melos run analyze

  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Melos
        uses: bluefireteam/melos-action@v3
        with:
          melos-version: '7.3.0'

      - name: Run tests
        run: melos run test

  pana:
    name: Pana Analysis
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - fledge_ecs
          - fledge_ecs_annotations
          - fledge_ecs_generator
          - fledge_render
          - fledge_render_2d
          - fledge_render_flutter
          - fledge_audio
          - fledge_input
          - fledge_window
          - fledge_tiled
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Melos
        uses: bluefireteam/melos-action@v3
        with:
          melos-version: '7.3.0'

      - name: Install Pana
        run: dart pub global activate pana

      - name: Run Pana on ${{ matrix.package }}
        run: |
          cd packages/${{ matrix.package }}
          pana --no-warning --exit-code-threshold 0

  build-examples:
    name: Build Examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Melos
        uses: bluefireteam/melos-action@v3
        with:
          melos-version: '7.3.0'

      - name: Generate code for basic_ecs example
        working-directory: examples/basic_ecs
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build basic_ecs example
        working-directory: examples/basic_ecs
        run: dart compile exe bin/main.dart -o basic_ecs

      - name: Build advanced_ecs example
        working-directory: examples/advanced_ecs
        run: dart compile exe bin/main.dart -o advanced_ecs

  build-docs:
    name: Build Docs
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Setup Melos
        uses: bluefireteam/melos-action@v3
        with:
          melos-version: '7.3.0'

      - name: Build docs
        working-directory: docs
        run: flutter build web
