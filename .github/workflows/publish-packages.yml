name: Publish Packages

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC token authentication with pub.dev
      contents: write  # Required for creating GitHub releases and pushing commits

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch full history for changelog generation
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Melos
        run: dart pub global activate melos

      - name: Bootstrap
        run: melos bootstrap

      - name: Update package versions
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          echo "Setting all packages to version $VERSION"

          for pubspec in packages/fledge_*/pubspec.yaml; do
            sed -i "s/^version: .*/version: $VERSION/" "$pubspec"
            echo "Updated: $pubspec"
          done

          # Show updated versions
          grep -r "^version:" packages/fledge_*/pubspec.yaml

      - name: Install git-cliff
        run: |
          curl -sSfL https://github.com/orhun/git-cliff/releases/download/v2.7.0/git-cliff-2.7.0-x86_64-unknown-linux-gnu.tar.gz | tar xz
          sudo mv git-cliff-2.7.0/git-cliff /usr/local/bin/
          git-cliff --version

      - name: Generate root changelog
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          DATE=$(date +%Y-%m-%d)

          # Generate changelog content for this release
          git-cliff --config cliff.toml --latest --strip header > CHANGES.md

          # Store for GitHub release
          {
            echo 'content<<EOF'
            cat CHANGES.md
            echo 'EOF'
          } >> $GITHUB_OUTPUT

          # Create new changelog entry
          echo "## [$VERSION] - $DATE" > CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md
          cat CHANGES.md >> CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md

          # Prepend to existing changelog or create new one
          if [ -f CHANGELOG.md ]; then
            # Skip the header if it exists
            tail -n +3 CHANGELOG.md >> CHANGELOG_NEW.md 2>/dev/null || true
          fi

          # Add header
          echo "# Changelog" > CHANGELOG.md
          echo "" >> CHANGELOG.md
          cat CHANGELOG_NEW.md >> CHANGELOG.md
          rm CHANGELOG_NEW.md CHANGES.md

      - name: Generate per-package changelogs
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          DATE=$(date +%Y-%m-%d)

          PACKAGES=(
            "fledge_ecs_annotations"
            "fledge_ecs"
            "fledge_ecs_generator"
            "fledge_render"
            "fledge_render_2d"
            "fledge_render_flutter"
            "fledge_audio"
            "fledge_window"
            "fledge_input"
            "fledge_tiled"
          )

          for pkg in "${PACKAGES[@]}"; do
            echo "Generating changelog for $pkg..."
            PKG_DIR="packages/$pkg"

            # Generate changelog for commits affecting this package
            # Uses --include-path to filter commits by path
            git-cliff --config cliff.toml --latest --strip header \
              --include-path "$PKG_DIR/**" > "$PKG_DIR/CHANGES.md" 2>/dev/null || true

            # Check if there are any changes for this package
            if [ -s "$PKG_DIR/CHANGES.md" ]; then
              echo "  Found changes for $pkg"

              # Create new changelog entry
              echo "## [$VERSION] - $DATE" > "$PKG_DIR/CHANGELOG_NEW.md"
              echo "" >> "$PKG_DIR/CHANGELOG_NEW.md"
              cat "$PKG_DIR/CHANGES.md" >> "$PKG_DIR/CHANGELOG_NEW.md"
              echo "" >> "$PKG_DIR/CHANGELOG_NEW.md"

              # Prepend to existing changelog or create new one
              if [ -f "$PKG_DIR/CHANGELOG.md" ]; then
                # Skip the header if it exists
                tail -n +3 "$PKG_DIR/CHANGELOG.md" >> "$PKG_DIR/CHANGELOG_NEW.md" 2>/dev/null || true
              fi

              # Add header
              echo "# Changelog" > "$PKG_DIR/CHANGELOG.md"
              echo "" >> "$PKG_DIR/CHANGELOG.md"
              cat "$PKG_DIR/CHANGELOG_NEW.md" >> "$PKG_DIR/CHANGELOG.md"
              rm "$PKG_DIR/CHANGELOG_NEW.md" "$PKG_DIR/CHANGES.md"
            else
              echo "  No changes for $pkg in this release"
              rm -f "$PKG_DIR/CHANGES.md"
            fi
          done

      - name: Commit version updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add packages/fledge_*/pubspec.yaml
          git add packages/fledge_*/CHANGELOG.md
          git add CHANGELOG.md

          VERSION=${{ steps.version.outputs.VERSION }}
          git commit -m "chore(release): v$VERSION [skip ci]" || echo "No changes to commit"

          git push origin HEAD:main

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body: ${{ steps.changelog.outputs.content }}
          tag_name: ${{ github.ref_name }}

      - name: Publish packages
        run: |
          # Publish in dependency order
          PACKAGES=(
            "fledge_ecs_annotations"
            "fledge_ecs"
            "fledge_ecs_generator"
            "fledge_render"
            "fledge_render_2d"
            "fledge_render_flutter"
            "fledge_audio"
            "fledge_window"
            "fledge_input"
            "fledge_tiled"
          )

          for pkg in "${PACKAGES[@]}"; do
            echo "Publishing $pkg..."
            cd packages/$pkg
            dart pub publish --force
            cd ../..
          done
