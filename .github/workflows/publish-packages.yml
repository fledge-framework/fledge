name: Publish Packages

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # Required for OIDC token authentication with pub.dev

    steps:
      - uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Melos
        run: dart pub global activate melos

      - name: Bootstrap
        run: melos bootstrap

      - name: Update package versions
        run: |
          VERSION=${{ steps.version.outputs.VERSION }}
          echo "Setting all packages to version $VERSION"

          for pubspec in packages/fledge_*/pubspec.yaml; do
            sed -i "s/^version: .*/version: $VERSION/" "$pubspec"
            echo "Updated: $pubspec"
          done

          # Show updated versions
          grep -r "^version:" packages/fledge_*/pubspec.yaml

      - name: Publish packages
        run: |
          # Publish in dependency order
          PACKAGES=(
            "fledge_ecs_annotations"
            "fledge_ecs"
            "fledge_ecs_generator"
            "fledge_render"
            "fledge_render_2d"
            "fledge_render_flutter"
            "fledge_audio"
            "fledge_window"
            "fledge_input"
            "fledge_tiled"
          )

          for pkg in "${PACKAGES[@]}"; do
            echo "Publishing $pkg..."
            cd packages/$pkg
            dart pub publish --force
            cd ../..
          done
